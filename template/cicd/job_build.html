<!DOCTYPE html>
<html>
<head>
    <title>{{.pipeline_name|shortName}} - CICD</title>

    {{include "base_head.html" .}}

</head>
<body>

<div class="ui container maincontainer">

    {{include "base_menu.html" .}}

    <div class="ui breadcrumb">
      <a class="section" href="{{.url|urlParentPath}}">Home</a>
      <div class="divider"> / </div>
      <a class="section" href="{{.url|urlParentPath}}">CICD</a>
      <div class="divider"> / </div>
      <a class="section" href="{{.url}}">{{.pipeline_name|shortName}}</a>
      <div class="divider"> / </div>
      <div class="active section">{{.job_id}}</div>
    </div>

    {{range .tasks}}

    <div class="ui icon message">
      <div class="content">
        <div class="header taskstatus1"></div>
        <hr>
        <p class="taskoutput" style="white-space: pre;"></p>
        <hr>
        <div class="taskstatus2" id="taskstatusbuttom"></div>

        <i style="color: red;" class="times circle outline icon" id="abort_btn"></i>
        <i class="arrow alternate circle up outline icon" id="up_btn"></i>
      </div>
        <hr>
    </div>

    <div id="jobtypeid" data-jobtype="BUILD" data-taskurl="{{$.taskurl}}{{.Id}}/log" data-aborturl="{{$.taskurl}}{{.Id}}/abort"></div>

    {{else}}

    <i class="ui active large loader"></i>

    {{end}}

</div>


{{include "base_foot.html" .}}


<script type="text/javascript">
    $('.ui.dropdown').dropdown();

    $(document).ready(function() {
      var jobtype = $("#jobtypeid").data("jobtype");
      if (jobtype == "BUILD") {
        var taskurl = $("#jobtypeid").data("taskurl");
        $.ajax({
          url: taskurl,
          type: 'GET',
          dataType: 'json',
          success: function(res) {
            var taskstatus = res.status;
            $('.taskstatus1').text(taskstatus);
            $('.taskoutput').text(res.output);
            $('.taskstatus2').text(taskstatus);

            if (taskstatus == 'running') {
                // var focusposition = document.getElementById("taskstatusbuttom").scrollHeight;
                var focusposition = document.getElementById("taskstatusbuttom").offsetTop;
                window.scrollTo(0, focusposition);
              // window.scrollTo(0, document.body.scrollHeight);
            }

            if (taskstatus != "success" && taskstatus != "failed") {
              var timer = setInterval(function () {
                  $.ajax({
                    url: taskurl,
                    type: 'GET',
                    dataType: 'json',
                    success: function(res) {
                      var taskstatus = res.status;
                      $('.taskstatus1').text(taskstatus);
                      $('.taskoutput').text(res.output);
                      // $('.taskstatus2').html(taskstatus + ' <i class="spinner loading icon"></i>');
                      $('#taskstatusbuttom').html(taskstatus + ' <i class="ui active inline tiny loader"></i>');

                      // console.log(taskstatus);
                      if(taskstatus == "success" || taskstatus == "failed"){
                          $('#taskstatusbuttom').html(taskstatus);
                          $("#abort_btn").remove();
                          clearInterval(timer);
                      }
                    }
                  });
              }, 1000);
            } else {
              $("#abort_btn").remove();
            }
          }
        });
      }
      if (jobtype === undefined) {
        setTimeout(function() {
            $.ajax({
              url: "",
              context: document.body,
              success: function(s,x) {
                  $(this).html(s);
              }
            });
        }, 1000);
      }
    });

    $("#abort_btn").click(function() {
      var aborturl = $("#jobtypeid").data("aborturl");
      $.post(aborturl, function (data) {
                    $('.info.modal .content').attr('style', 'white-space: pre;');
                    $('.info.modal .content').html(data.output);
                    $(".info.modal").modal({closable:true,observeChanges:true}).modal('show');
                }, 'json');

    });

    $("#up_btn").click(function() {
      window.scrollTo(0, 0);
    });

    window.onscroll = function() {
        if(window.scrollY > 500){
          document.getElementById('up_btn').style.display = 'block';
        }
        else{
          document.getElementById('up_btn').style.display = none;
        }
    }

</script>

</body>
</html>
